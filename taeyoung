# ì£¼í”¼í„° ë…¸íŠ¸ë¶ì—ì„œ ì‹¤í–‰í•˜ë©´ ë˜ëŠ”ë° vscode ì£¼í”¼í„° ì…€ì—ì„œ ì‹¤í–‰í•˜ë©´ ctrl+shift+p í–ˆì„ ë•Œ ì²˜ëŸ¼ ë§¨ ìœ„ ì¤‘ì•™ ê²€ìƒ‰ ì°½ì— ì‚¬ìš©ìê°€ ì§ˆë¬¸ì„ í•˜ë©´ ë¨
# api í‚¤ëŠ” ë‚´ê»„ë¡œ ì„¤ì •í•´ë†¨ê³  ì¢…ë£Œí•˜ê³  ì‹¶ì„ ë• \quit ì•„ë‹ˆë©´ /quitë¥¼ ì‚¬ìš©ì ì§ˆë¬¸ì°½ì— ì…ë ¥í•˜ë©´ ì¢…ë£Œë¨
import requests
import json
import sys

# Watson X AI ì±—ë´‡ í´ë˜ìŠ¤
class WatsonChatbot:
    def __init__(self, api_key):
        self.api_key = api_key
        self.token = None
        self.conversation_history = []
        self.endpoint = 'https://us-south.ml.cloud.ibm.com/ml/v4/deployments/6261f83b-14d4-4666-9243-2cb36bdcd698/ai_service_stream?version=2021-05-01'
        self.authenticate()
    
    def authenticate(self):
        """IBM Cloud API ì¸ì¦"""
        print(f"ğŸ” API í‚¤ ê¸¸ì´: {len(self.api_key)} ë¬¸ì")
        print(f"ğŸ” API í‚¤ ì‹œì‘: {self.api_key[:10]}...")
        
        try:
            # API í‚¤ ê²€ì¦
            if not self.api_key or self.api_key == "<your API key>":
                print("âŒ ì˜¬ë°”ë¥¸ API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!")
                sys.exit(1)
            
            # API í‚¤ ì •ë¦¬ (ê³µë°± ì œê±°)
            clean_api_key = self.api_key.strip()
            
            token_response = requests.post(
                'https://iam.cloud.ibm.com/identity/token', 
                data={
                    "apikey": clean_api_key, 
                    "grant_type": 'urn:ibm:params:oauth:grant-type:apikey'
                },
                headers={'Content-Type': 'application/x-www-form-urlencoded'}
            )
            
            print(f"ğŸ” ì¸ì¦ ì‘ë‹µ ìƒíƒœ ì½”ë“œ: {token_response.status_code}")
            
            if token_response.status_code == 400:
                print("âŒ API í‚¤ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ìŒì„ í™•ì¸í•´ì£¼ì„¸ìš”:")
                print("   1. IBM Cloud ì½˜ì†”ì—ì„œ API í‚¤ë¥¼ ë‹¤ì‹œ í™•ì¸")
                print("   2. API í‚¤ì— ê³µë°±ì´ë‚˜ íŠ¹ìˆ˜ë¬¸ìê°€ í¬í•¨ë˜ì–´ ìˆì§€ ì•Šì€ì§€ í™•ì¸")
                print("   3. API í‚¤ê°€ ë§Œë£Œë˜ì§€ ì•Šì•˜ëŠ”ì§€ í™•ì¸")
                print(f"   ì‘ë‹µ ë‚´ìš©: {token_response.text}")
                sys.exit(1)
            
            token_response.raise_for_status()
            response_data = token_response.json()
            
            if "access_token" not in response_data:
                print(f"âŒ í† í°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {response_data}")
                sys.exit(1)
                
            self.token = response_data["access_token"]
            print("âœ… Watson X AI ì¸ì¦ ì„±ê³µ!")
            
        except requests.exceptions.RequestException as e:
            print(f"âŒ ì¸ì¦ ì‹¤íŒ¨: {e}")
            if hasattr(e, 'response') and e.response is not None:
                print(f"   ì‘ë‹µ ë‚´ìš©: {e.response.text}")
            sys.exit(1)
        except Exception as e:
            print(f"âŒ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜: {e}")
            sys.exit(1)
    
    def send_message(self, user_message):
        """ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ Watson X AIë¡œ ì „ì†¡"""
        # ëŒ€í™” íˆìŠ¤í† ë¦¬ì— ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
        self.conversation_history.append({
            "role": "user", 
            "content": user_message
        })
        
        # API ìš”ì²­ í˜ì´ë¡œë“œ ì¤€ë¹„
        payload_scoring = {
            "messages": self.conversation_history.copy()
        }
        
        headers = {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + self.token
        }
        
        try:
            # Watson X AI API í˜¸ì¶œ
            response = requests.post(
                self.endpoint, 
                json=payload_scoring, 
                headers=headers,
                stream=True  # ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ ì²˜ë¦¬
            )
            response.raise_for_status()
            
            # ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ ì²˜ë¦¬
            ai_response = ""
            print("ğŸ¤– Watson AI: ", end="", flush=True)
            
            for line in response.iter_lines():
                if line:
                    try:
                        # JSON ë¼ì¸ íŒŒì‹±
                        line_text = line.decode('utf-8')
                        if line_text.startswith('data: '):
                            json_text = line_text[6:]  # 'data: ' ì œê±°
                            if json_text.strip() == '[DONE]':
                                break
                            
                            data = json.loads(json_text)
                            if 'choices' in data and len(data['choices']) > 0:
                                delta = data['choices'][0].get('delta', {})
                                if 'content' in delta:
                                    content = delta['content']
                                    ai_response += content
                                    print(content, end="", flush=True)
                    except (json.JSONDecodeError, KeyError):
                        continue
            
            print()  # ì¤„ë°”ê¿ˆ
            
            # ëŒ€í™” íˆìŠ¤í† ë¦¬ì— AI ì‘ë‹µ ì¶”ê°€
            if ai_response:
                self.conversation_history.append({
                    "role": "assistant", 
                    "content": ai_response
                })
            
            return ai_response
            
        except requests.exceptions.RequestException as e:
            print(f"âŒ API í˜¸ì¶œ ì‹¤íŒ¨: {e}")
            return None
    
    def clear_conversation(self):
        """ëŒ€í™” íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™”"""
        self.conversation_history = []
        print("ğŸ”„ ëŒ€í™” íˆìŠ¤í† ë¦¬ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.")
    
    def show_conversation_history(self):
        """ëŒ€í™” íˆìŠ¤í† ë¦¬ ì¶œë ¥"""
        if not self.conversation_history:
            print("ğŸ“ ëŒ€í™” íˆìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.")
            return
        
        print("ğŸ“ ëŒ€í™” íˆìŠ¤í† ë¦¬:")
        print("-" * 50)
        for i, message in enumerate(self.conversation_history, 1):
            role = "ğŸ‘¤ ì‚¬ìš©ì" if message['role'] == 'user' else "ğŸ¤– Watson AI"
            print(f"{i}. {role}: {message['content'][:100]}{'...' if len(message['content']) > 100 else ''}")
        print("-" * 50)

def main():
    print("ğŸš€ Watson X AI ì±—ë´‡ì„ ì‹œì‘í•©ë‹ˆë‹¤!")
    print("ğŸ’¡ ëª…ë ¹ì–´:")
    print("  - '/clear': ëŒ€í™” íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™”")
    print("  - '/history': ëŒ€í™” íˆìŠ¤í† ë¦¬ ë³´ê¸°")
    print("  - '/quit' ë˜ëŠ” '/exit': ì±—ë´‡ ì¢…ë£Œ")
    print("=" * 50)
    
    # API í‚¤ ì…ë ¥ ë° í™•ì¸
    API_KEY = "fnuO5k8mU3q_NeAw7e2EzYg4URqqup2pdbnENGjItcj8"  # ì‹¤ì œ API í‚¤ë¡œ êµì²´í•˜ì„¸ìš”
    
    if API_KEY == "<your API key>":
        print("\nğŸ”‘ IBM Cloud API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")
        print("ğŸ’¡ API í‚¤ ì°¾ëŠ” ë°©ë²•:")
        print("   1. IBM Cloud ì½˜ì†” (https://cloud.ibm.com) ë¡œê·¸ì¸")
        print("   2. ê´€ë¦¬ > ì•¡ì„¸ìŠ¤(IAM) > API í‚¤")
        print("   3. ìƒˆ API í‚¤ ìƒì„± ë˜ëŠ” ê¸°ì¡´ í‚¤ ë³µì‚¬")
        print("   4. Watson Machine Learning ì„œë¹„ìŠ¤ ì•¡ì„¸ìŠ¤ ê¶Œí•œ í™•ì¸")
        print()
        
        while True:
            API_KEY = input("API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”: ").strip()
            if API_KEY and len(API_KEY) > 20:  # IBM API í‚¤ëŠ” ë³´í†µ 40ì ì´ìƒ
                break
            else:
                print("âŒ ì˜¬ë°”ë¥¸ API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. (ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤)")
    
    # API í‚¤ ê°„ë‹¨ ê²€ì¦
    if not API_KEY or len(API_KEY) < 20:
        print("âŒ ì˜¬ë°”ë¥¸ IBM Cloud API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!")
        return
    
    print(f"\nğŸ” API í‚¤ í™•ì¸: {API_KEY[:8]}...{API_KEY[-4:]}")
    
    try:
        # ì±—ë´‡ ì´ˆê¸°í™”
        chatbot = WatsonChatbot(API_KEY)
        
        # ë©”ì¸ ëŒ€í™” ë£¨í”„
        while True:
            try:
                user_input = input("\nğŸ‘¤ ì‚¬ìš©ì: ").strip()
                
                if not user_input:
                    continue
                
                # íŠ¹ìˆ˜ ëª…ë ¹ì–´ ì²˜ë¦¬
                if user_input.lower() in ['/quit', '/exit']:
                    print("ğŸ‘‹ ì±—ë´‡ì„ ì¢…ë£Œí•©ë‹ˆë‹¤. ì•ˆë…•íˆ ê°€ì„¸ìš”!")
                    break
                elif user_input.lower() == '/clear':
                    chatbot.clear_conversation()
                    continue
                elif user_input.lower() == '/history':
                    chatbot.show_conversation_history()
                    continue
                elif user_input.lower() == '/test':
                    # API ì—°ê²° í…ŒìŠ¤íŠ¸
                    print("ğŸ”§ API ì—°ê²°ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤...")
                    test_response = chatbot.send_message("ì•ˆë…•í•˜ì„¸ìš”!")
                    if test_response:
                        print("âœ… API ì—°ê²° í…ŒìŠ¤íŠ¸ ì„±ê³µ!")
                    else:
                        print("âŒ API ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨!")
                    continue
                
                # Watson AIì—ê²Œ ë©”ì‹œì§€ ì „ì†¡
                response = chatbot.send_message(user_input)
                
                if response is None:
                    print("âš ï¸ ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.")
            
            except KeyboardInterrupt:
                print("\n\nğŸ‘‹ ì‚¬ìš©ìê°€ ì±—ë´‡ì„ ì¢…ë£Œí–ˆìŠµë‹ˆë‹¤. ì•ˆë…•íˆ ê°€ì„¸ìš”!")
                break
            except Exception as e:
                print(f"âŒ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")
                
    except Exception as e:
        print(f"âŒ ì±—ë´‡ ì´ˆê¸°í™” ì‹¤íŒ¨: {e}")
        print("\nğŸ”§ ë¬¸ì œ í•´ê²° ë°©ë²•:")
        print("   1. API í‚¤ê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸")
        print("   2. IBM Cloud ê³„ì •ì— Watson Machine Learning ì„œë¹„ìŠ¤ê°€ í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸")
        print("   3. API í‚¤ì— ì ì ˆí•œ ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸")
        print("   4. ë„¤íŠ¸ì›Œí¬ ì—°ê²° ìƒíƒœ í™•ì¸")

if __name__ == "__main__":
    main()
